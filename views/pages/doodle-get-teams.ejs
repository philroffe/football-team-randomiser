<html>

<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
@viewport {
  width: device-width ;
  zoom: 1.0 ;
}
.linkborder a:link, .emailHeader {
  background-color: #EEEEEE;
  color: #333333;
  padding: 2px 6px 2px 6px;
  border-top: 1px solid #CCCCCC;
  border-right: 1px solid #333333;
  border-bottom: 1px solid #333333;
  border-left: 1px solid #CCCCCC;
}
</style>

</head>

<body>
  <div id="outer">
    <!-- Divs content is autogenerated from javascript -->
    <div id="doodleLink">Not Yet Available</div><br>
    <div id="emailTitle">Not Yet Available</div> 
    <pre class="emailHeader"><div id="emailBody">Not Yet Available</div></pre>
    <button type="button" onclick="generateTeams()">Randomise Again!</button><p>

    <div class="linkborder" id="emailLink">Not Yet Available</div> 

    <script type="text/javascript">
    function generateTeams() {
      var doodleTeams = <%- JSON.stringify(doodleTeams.options) %>;
      var doodleId = "<%= doodleTeams.id %>";
      var doodleLink = "https://doodle.com/poll/" + doodleId
      var options = <%- JSON.stringify(doodleTeams.options) %>;
      var players = <%- JSON.stringify(doodleTeams.participants) %>;

      // Get the date next Monday (and check if today is a Monday too)
      var d = new Date();
      //d = new Date('11 Aug 2021'); // useful for testing
      if (d.getDay() != 1) {
        d.setDate(d.getDate() + (1 + 7 - d.getDay()) % 7);
      }

      // loop throught the options and find the index for next Monday
      var nextMondayOptionIndex = -1
      Object.keys(options).forEach(function(key) {
        optionDate = new Date(options[key].date);
        if (datesAreOnSameDay(optionDate, d)) {
          nextMondayOptionIndex = key
        }
      });
      // if (nextMondayOptionIndex != -1) {
      //   console.log('Found next Monday option:' + nextMondayOptionIndex);
      // } else {
      //   console.log('No game this upcoming Monday:' + d);
      // }

      // Get the players who have ticked this option
      var playersList = []
      Object.keys(players).forEach(function(key) {
        playerName = players[key].name;
        playerCanPlay = players[key].preferences[nextMondayOptionIndex];
        if (playerCanPlay == 1) {
          playersList.push(playerName);
        }
      });

      // randomise the player list
      //console.log(playersList);
      shuffle(playersList);
      //console.log(playersList);

      // divide into reds and blues
      var redPlayers = []
      var bluePlayers = []
      var standbyPlayers = []
      var playerCount = playersList.length;
      var maxPlayersPerTeam = Math.floor(playerCount/2)
      for (var i = 0; i < playerCount; i++) {
        if (i < 12) {
          // evens on reds, odds on blues
          if (i%2 == 0) {
            if (redPlayers.length < maxPlayersPerTeam) {
              redPlayers.push(playersList[i]);
            } else {
              standbyPlayers.push(playersList[i]);
            }
          } else {
            if (bluePlayers.length < maxPlayersPerTeam) {
              bluePlayers.push(playersList[i]);
            } else {
              standbyPlayers.push(playersList[i]);
            }
          }
        } else {
          standbyPlayers.push(playersList[i]);
        }
      }

      // console.log("Red :" + redPlayers);
      // console.log("Blue:" + bluePlayers);
      // console.log("StandBy:" + standbyPlayers);

      //////////////////////
      // generate email text
      //////////////////////
      var emailHeader = ""
      var emailSubject = ""
      if (playerCount == 0) {
        emailHeader = "Only " + playerCount + " players this week - any more or should I cancel?"
        emailSubject = "NO PLAYERS FOUND - CHECK DATE AND DOODLE LINK IS CORRECT: "
      } else if (playerCount <= 6) {
        emailHeader = "Only " + playerCount + " players this week - any more or should I cancel?"
        emailSubject = "LOTS of Players Needed"
      } else if (playerCount == 7) {
        emailHeader = "Only " + playerCount + " players so far - 3 needed.\nAnyone?"
        emailSubject = "3 Players Needed"
      } else if (playerCount == 8) {
        emailHeader = "Only " + playerCount + " players so far so 4-a-side as it stands. 2 players needed to make 10.\nAnyone fancy a game?"
        emailSubject = "2 Players Needed"
      } else if (playerCount == 9) {
        emailHeader = playerCount + " players so far this week - 1 needed to make it an even 5-a-side.\nAnyone fancy a game?"
        emailSubject = "1 Players Needed"
      } else if (playerCount == 10) {
        emailHeader = playerCount + " players this week so 5-a-side and game on."
        emailSubject = "Teams"
      } else if (playerCount == 11) {
        emailHeader = playerCount + " players this week - so 5-a-side with 1 on standby (see below), or 1 needed to make it 6-a-side.\nAnyone fancy a game?"
        emailSubject = "Teams"
      } else if (playerCount == 12) {
        emailHeader = playerCount + " players this week, so 6-a-side and game on."
        emailSubject = "Teams"
      } else if (playerCount > 12) {
        emailHeader = playerCount + " players this week, so 6-a-side with some on standby - see names below."
        emailSubject = "Teams"
      }

      let mo = new Intl.DateTimeFormat('en', { month: 'short' }).format(d);
      let da = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(d);

      fullEmailSubject = emailSubject + " - Mon " + da + " " + mo + " [Footie, Goodwin, 6pm Mondays]\n"
      fullEmailText = "Hi all,\n\n" + emailHeader + "\n\nTeams below... (any changes let me know asap)\n\n"

      fullEmailText += "REDS\n"
      for (var i = 0; i < redPlayers.length; i++) {
        fullEmailText += i+1 + " " + redPlayers[i] + "\n"
      }
      fullEmailText += "\n"
      fullEmailText += "BLUES\n"
      for (var i = 0; i < bluePlayers.length; i++) {
        fullEmailText += i+1 + " " + bluePlayers[i] + "\n"
      }
      if (standbyPlayers.length > 0) {
        fullEmailText += "\n"
        fullEmailText += "STANDBY\n"
        for (var i = 0; i < standbyPlayers.length; i++) {
          fullEmailText += i+1 + " " + standbyPlayers[i] + "\n"
        }
      }
      fullEmailText += "\nCheers,\nPhil\n"
      fullEmailText += "\nMobile: 07960951917\n"
      fullEmailText += doodleLink + "\n"

      //Print html header
      document.getElementById("emailTitle").innerHTML = fullEmailSubject
      document.getElementById("emailBody").innerHTML = fullEmailText
      document.getElementById("doodleLink").innerHTML="Generated from: <a href='" + doodleLink + "'>" + doodleLink + "</a>"

      // generate email link
      emailTo = "footie"
      emailBodyUrlEnc = encodeURI(fullEmailText)
      emailLinkHTML = "<a href=\"http://mail.google.com/mail/u/?authuser=philroffe@gmail.com&view=cm&fs=1&tf=1" + 
      "&to=" + emailTo + 
      "&su=" + fullEmailSubject +
      "&body=" + emailBodyUrlEnc +
      "\" target=\"_blank\">Generate email (needs a google account)</a>" 
      document.getElementById("emailLink").innerHTML = emailLinkHTML
    }

    function shuffle(array) {
      var currentIndex = array.length,  randomIndex;

      // While there remain elements to shuffle...
      while (currentIndex != 0) {
        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
        array[randomIndex], array[currentIndex]];
      }

      return array;
    }

    function datesAreOnSameDay(first, second) {
      return first.getFullYear() === second.getFullYear() &&
        first.getMonth() === second.getMonth() &&
        first.getDate() === second.getDate();
    }

    generateTeams()
    </script>

    </body>

</html>
