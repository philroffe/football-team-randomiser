<!DOCTYPE html>
<html lang="en">
<head>
  <%- include ("../partials/header.ejs") %>

  <style>
  .linkborder, .emailHeader {
    background-color: #D5EDF6;
    color: #333333;
    padding: 2px 6px 2px 6px;
    border-top: 1px solid #D5EDF6;
    border-right: 1px solid #333333;
    border-bottom: 1px solid #333333;
    border-left: 1px solid #D5EDF6;
  }

  .collapse {
      border: none;
      outline: none;
  }
  .active,
  .collapse:hover {
    background-color: #438a5e;
  }
  .emailListText {
    background-color: #e1ffc2;
    display: none;
  }
  </style>
</head>

<body class="w3-light-grey">
  <%- include ("../partials/nav.ejs") %>

  <!-- Page content -->
  <div class="w3-content" style="max-width:2000px;margin-top:46px;margin-left: 10px;">
    <!-- Divs content is autogenerated from javascript -->
    <h3>Team Randomiser</h3>
    <div id="pollLink">Not Yet Available</div>
    <div id="optionDates">Not Yet Available</div><br>

    <div style="display: flex;">
      <div id="chooseOptionAlgorithm" style="display:inline;">
        Order By:
        <select name="algorithmChoice" id="algorithmChoice" checked onchange="changeAlgorithm(this.value)">
          <option value="algorithm0">Random</option>
          <option value="algorithm1">Win Ratio</option>
          <option value="algorithm2">Win+Draw Ratio</option>
          <option value="algorithm3">Avg Score Per Game</option>
          <option value="algorithm4">Total Score Per Game</option>
          <option value="algorithm5">Most Played</option>
          <option value="algorithm6">Goals Per Game</option>
        </select>
        <button class="linkborder" onclick=";changeAlgorithm('algorithm0')" id="randomiseAgain">Randomise Players Again!</button>
      </div>
    
      <div id="chooseOptionAlgorithmChoice" style="display:inline;">
        <select name="algorithmChoiceRange" id="algorithmChoiceRange" checked onchange="changeAlgorithmRange(this.value)">
          <option value="12">12 Months</option>
          <option value="6">6 Months</option>
          <option value="3">3 Months</option>
          <option value="999999999">Since Jan23</option>
        </select>
      </div>

      <div id="chooseOptionAlgorithmName" style="display:inline;">
        <select name="algorithmName" id="algorithmName" checked onchange="changeAlgorithmName(this.value)">
          <option value="ParityGPG">ParityGPG</option>
          <option value="Parity">Parity</option>
          <option value="Exhaustive">Exhaustive</option>
          <option value="Alternate">Alternate</option>
        </select>
      </div>

      <div id="chooseShowDatesInPayments" style="display:inline;margin-left:10px;">
        <label for="showDatesInPayments">Show Dates in Payments?</label><input type="checkbox" id="showDatesInPayments" name="showDatesInPayments" style="background: #eee;" onclick="generateAvailabilityEmailText();">
      </div>
    </div>

    <div style="display: flex;">
      <div id="chooseOption" style="display:inline;">
        Email Template:
        <select name="emailChoice" id="emailChoice" checked onchange="changeOption(this.value)">
          <option value="teams">Teams</option>
          <option value="availability">Availability</option>
          <option value="payments">Payments</option>
          <option value="welcome">Welcome</option>
        </select>
      </div>
      <input type="text" id="emailTitle" style="width:50%;font-size: 90%;" data-lpignore=true>
    </div>

    <div style="width:100%;display:flex;">
      <div id="emailEntryDiv" style="display:inline;width:55%"><textarea id="emailBody" rows="30" style="width:95%;font-size: 90%;margin-top:10px" >Not Yet Available</textarea></div>
      <div id="paymentsEntryDiv" style="display:inline;width:44%;font-size: 80%;"></div>
    </div> 
    <br>

    <div id="sendEmailDiv">
      <input type="checkbox" id="sendTestEmailList" name="sendTestEmailList" value="Test" style="background: #eee;" onclick="updateEmailButton();"><label for="sendTestEmailList">Send Test Email?</label>
          <div class="collapse"> >>> Show email addresses...</div>
          <div id="emailListText" class="emailListText">(javascript will populate emails)</div>
          <script>
            var btn = document.getElementsByClassName("collapse");
            btn[0].addEventListener("click", function () {
              this.classList.toggle("active");
              var content = this.nextElementSibling;
              if (content.style.display === "block") {
                content.style.display = "none";
              } else {
                content.style.display = "block";
              }
           });
          </script>
      <p>
      <button id="sendEmail" style="background-color: #90EE90;float:left;" type="button" onclick="sendEmail();">Send Email to ALL players</button>
      <div style="float:left;margin-left:20px;padding:5px;">... Or Manual Email Creation:</div>
        <div class="linkborder" style="float:left;" id="emailLinkMobile">Not Yet Available</div>
        <div class="linkborder" style="float:left;" id="emailLinkDesktop">Not Yet Available</div>
    </div>

    <br><br>

  </div>

  <%- include ("./admin-payments.ejs") %>
  <script>
  <%- include ("./generate-teams-utils.js") %>

  // restringify and then parse the json to get the page
  var pagedata = JSON.parse(JSON.stringify(<%- pageData %>));
  console.log('Data=', pagedata);

  var nextMondayText = pagedata.nextMonday;
  var nextMondayDate = new Date(nextMondayText);
  //var todayDate = new Date();
  var todayDate = nextMondayDate;
  var pollLink = "https://tensile-spirit-360708.nw.r.appspot.com/poll";
  var optionDates = "";
  var pollDate = "";
  var monthDateFormat = new Intl.DateTimeFormat('en', { month: 'short' });
  var monthDateLongFormat = new Intl.DateTimeFormat('en', { month: 'long' });
  var monthDateNumericFormat = new Intl.DateTimeFormat('en', { month: '2-digit' });
  var dayDateFormat = new Intl.DateTimeFormat('en', { day: '2-digit' });

  var playerNameSuggestions, allAttendanceData, outstandingPayments, playersPreviewData;
  //var playersList = [];

  var algorithmTitle = { "algorithm0": "Everyone Randomly Weighted", 
                         "algorithm1": "Win Ratio (W|D|L)", 
                         "algorithm2": "Win+Draw ratio (W|D|L)",
                         "algorithm3": "Average generated score per game\n(5 for win, 3 for draw, 1 for loss,\n 0 for not-played)", 
                         "algorithm4": "Total generated score per game\n(5 for win, 3 for draw, 1 for loss,\n 0 for not-played)",
                         "algorithm5": "Most Played (W|D|L)",
                         "algorithm6": "Goals Per Game"}
  var algorithmRange = 12; //default
  var algorithmName = "ParityGPG"; //default

    var players = pagedata.data.players;
    if (!players) { players = {}; }
    var gameMonth = pagedata.data.gameMonth;
    if (!gameMonth) gameMonth = monthDateNumericFormat.format(todayDate);
    var gameYear = pagedata.data.gameYear;
    if (!gameYear) gameYear = todayDate.getFullYear();
    allAttendanceData = pagedata.data.allAttendanceData;
    if (!allAttendanceData) { allAttendanceData = {}; }
    outstandingPayments = pagedata.data.outstandingPayments;
    if (!outstandingPayments) { outstandingPayments = {}; }
    playersPreviewData = pagedata.data.playersPreviewData;
    if (!playersPreviewData) { playersPreviewData = {}; }

    //pollDate = new Date("01 " + monthDateFormat.format(todayDate) + " " + gameYear);
    pollDate = new Date("01 " + monthDateFormat.format(todayDate) + " " + gameYear);
    //console.log(pollDate);
    var gameMonthString = monthDateFormat.format(todayDate);

    //console.log("allAttendanceData=", allAttendanceData);
    //console.log("outstandingPayments=", outstandingPayments);

    // collate the aliases
    var playerAliasMaps = pagedata.data.playerAliasMaps;
    var playerToAliasMap = playerAliasMaps["playerToAliasMap"];
    var aliasToPlayerMap = playerAliasMaps["aliasToPlayerMap"];
    playerNameSuggestions = Array.from(Object.keys(playerToAliasMap));
    // define some test email addresses
    var testEmailList = [ "Phil RT1 <philroffe+test1@gmail.com>", "Phil RT2 <philroffe+test2@gmail.com>"];
    // update Send Email button to show the number of people on the mailiing list
    document.getElementById("sendEmail").innerHTML = "Send Email to " + Object.keys(playerAliasMaps.activeEmailList).length + " players";


    var user = pagedata.user;
    if (user) {
      document.getElementById("sendEmailDiv").style.visibility = "visible";

      // set the collapsed email
      var activeEmailList = playerAliasMaps.activeEmailList;
      var allEmails = "";
      Object.keys(activeEmailList).forEach(function(key) {
        allEmails += activeEmailList[key] + "; ";
      });
      document.getElementById("emailListText").textContent = allEmails;
    } else {
      document.getElementById("sendEmailDiv").style.visibility = "hidden";
    }
    
    function mondaysInMonth(m,y) {
      var lastDateOfMonth = new Date(y,m,0).getDate();
      var firstDayNumberOfMonth =  new Date(m +'/01/'+ y).getDay(); // 0=Sun, 1=Mon...

      // check what day the 1st of the month is, and then calc the date of the next Monday
      var mondayDate;
      if (firstDayNumberOfMonth == 1) {
        // already a Monday (1st of the month)
        mondayDate = 1;
      } else if (firstDayNumberOfMonth == 0) {
        // it's a Sunday, so Monday is 1 day away (2nd of the month)
        mondayDate = 2;
      } else {
        // must be Tues-Sat so subtract from 9 (because max 7 days from )
        var mondayDate = 7 - (firstDayNumberOfMonth - 2);
      }

      // now loop through every 7 days and form an array of Monday dates
      var mondays = [];
      for (var i = mondayDate; i <= lastDateOfMonth; i += 7) {
        mondays.push(i);
      }

      console.log("First Monday of month:", new Date(m +'/0' + mondays[0] + '/'+ y));
      //console.log("Mondays in the month:", mondays);
      return mondays;
    }

    mondaysDates = mondaysInMonth(pollDate.getMonth()+1, pollDate.getFullYear());  //=> [ 7,14,21,28 ]
    var nextMondayOptionIndex = getNextMondayIndex(mondaysDates, nextMondayDate);
    console.log("mondaysDates:", mondaysDates, nextMondayOptionIndex);


    var optionDates = "Dates";
    Object.keys(mondaysDates).forEach(function(key) {
      // Generate the text for the options (with next Monday in bold)
      optionDate = new Date(mondaysDates[key] + " " + monthDateFormat.format(nextMondayDate) + " " + nextMondayDate.getFullYear());
      optionDateText = dayDateFormat.format(optionDate) + " " + monthDateFormat.format(optionDate);
      if (datesAreOnSameDay(optionDate, nextMondayDate)) {
        optionDates += " : <b><u>" + optionDateText + " </u></b>"
      } else {
        optionDates += " : " + optionDateText
      }
    });

  function updateDivText() {
      //Update div text values
      document.getElementById("pollLink").innerHTML="Generated from: <a href='" + pollLink + "'>" + monthDateLongFormat.format(pollDate) + "</a>"
      document.getElementById("optionDates").innerHTML = optionDates
      document.getElementById("emailTitle").value = fullEmailSubject
      document.getElementById("emailBody").value = fullEmailText
      // generate email link
      emailTo = "footie"
      emailBodyUrlEnc = encodeURI(fullEmailText)
      emailLinkHTML = "<a href=\"http://mail.google.com/mail/u/?authuser=philroffe@gmail.com&view=cm&fs=1&tf=1" + 
        "&to=" + emailTo + 
        "&su=" + fullEmailSubject +
        "&body=" + emailBodyUrlEnc +
        "\" target=\"_blank\">Gmail Webmail</a>" 
        document.getElementById("emailLinkDesktop").innerHTML = emailLinkHTML

        emailLinkHTML = "<a href=\"mailto:" + emailTo + "?subject=" + fullEmailSubject + "&body=" + emailBodyUrlEnc + "\">Mobile</a>" 
        document.getElementById("emailLinkMobile").innerHTML = emailLinkHTML
  }

  function changeAlgorithm(algorithmType) {
    // calculate updated URL
    var newURL = window.location.href;
    if (window.location.href.includes("algorithm=")) {
      newURL = window.location.href.replace(/(algorithm=)\w+/g, 'algorithm=' + algorithmType.at(-1));
    } else {
      (window.location.href.includes("?")) ? newURL += "&" : newURL += "?";
      newURL += "algorithm=" + algorithmType.at(-1);
    }
    // update the URL (without refreshing) to reflect tab change
    window.history.pushState({}, 'unused', newURL);

    // display the right div
    document.getElementById("paymentsEntryDiv").innerHTML = algorithmType;

    if (algorithmType == "algorithm0") {
      document.getElementById("randomiseAgain").style.display = "block";
    } else {
      document.getElementById("randomiseAgain").style.display = "none";
    }

    // change the algorithm for all players and regenerate teams
    var playersGamesPlayedRatio = changeAlgorithmForPlayers(algorithmType, algorithmName, players, playersPreviewData, allAttendanceData, aliasToPlayerMap, nextMondayOptionIndex, algorithmRange);

    // get the generated variables returned as playersGamesPlayedRatio
    var totalPossibleGames = playersGamesPlayedRatio.totalPossibleGames;
    var sortedPlayers = playersGamesPlayedRatio.sortedPlayers;
    var generatedTeams = playersGamesPlayedRatio.generatedTeams;
    var standbyPlayers = generatedTeams.standbyPlayers;
    if (generatedTeams) {
      var redPlayers = shuffle(generatedTeams.redPlayers);
      var bluePlayers = shuffle(generatedTeams.bluePlayers);

      // print the list for viewing
      var playerStringList = "";
      for (var i = 0; i < sortedPlayers.length; i++) {
        playerName = sortedPlayers[i][0];
        playerNameClean = playerName.replace(/&#39;/g, "'");
        playerAlgorithmScore = Number(sortedPlayers[i][1][algorithmType + "ratio"]).toFixed(2);

        var cssStyle = "";
        if (redPlayers.includes(playerName)) {
          cssStyle = "font-weight:bold;color:white;background-color:red";
        } else if (bluePlayers.includes(playerName)) {
          cssStyle = "font-weight:bold;color:white;background-color:blue";
        } else if (standbyPlayers.includes(playerName)) {
          cssStyle = "font-weight:bold;color:white;background-color:gold";
        }
        
        var wonLostDrawnString = "(" + playersGamesPlayedRatio[playerName].won + "|" + playersGamesPlayedRatio[playerName].drawn + "|" + playersGamesPlayedRatio[playerName].lost + ")";
        wonLostDrawnString = wonLostDrawnString.padEnd(10);
        var playerAlgorithmScoreString = playerAlgorithmScore.padEnd(5);

        // slight change for some algorithms
        if (algorithmType == "algorithm6") {
          wonLostDrawnString = "";
          wonLostDrawnString = wonLostDrawnString.padEnd(3);
          playerAlgorithmScoreString = Number(playerAlgorithmScore).toFixed(2);
        }

        playerStringList += "<div style='" + cssStyle + "'>" + playerAlgorithmScoreString + " " + wonLostDrawnString  + playerNameClean + "\n</div>";

      }
      document.getElementById("paymentsEntryDiv").innerHTML = '<pre>' + algorithmTitle[algorithmType] 
        + '\n(Total No of Games: ' + totalPossibleGames + ')\n\n'
        + playerStringList + '</pre>';

      generateTeamsEmailText(generatedTeams, nextMondayDate);
      updateDivText();
    }

    return playersGamesPlayedRatio;
  }

  function changeAlgorithmRange(newAlgorithmRange) {
    algorithmRange = newAlgorithmRange;
    changeAlgorithm(document.getElementById("algorithmChoice").value)
  }
  

  function changeAlgorithmName(newAlgorithmName) {
    algorithmName = newAlgorithmName;
    changeAlgorithm(document.getElementById("algorithmChoice").value)
  }

  function changeOption(emailChoice) {
    //console.log("email choice:", emailChoice)
    if (emailChoice == "teams") {
      document.getElementById("chooseOptionAlgorithm").style.display = "block";
      changeAlgorithm(document.getElementById("algorithmChoice").value);
      //console.log("AAA", document.getElementById("algorithmChoice").value)
      //updateDivText();
    } else if (emailChoice == "availability") {
      document.getElementById("chooseOptionAlgorithm").style.display = "none"
      generateAvailabilityEmailText();
    } else if (emailChoice == "payments") {
      document.getElementById("chooseOptionAlgorithm").style.display = "none"
      generatePaymentsEmailText();
    } else if (emailChoice == "welcome") {
      document.getElementById("chooseOptionAlgorithm").style.display = "none"
      generateFirstIntroEmailText();
    }
  }

  function generateAvailabilityEmailText() {
    document.getElementById("paymentsEntryDiv").innerHTML = '<p>';
    var showExpandedDates = document.getElementById("showDatesInPayments").checked;
    addPaymentsTableRows(outstandingPayments, true, showExpandedDates);

    var dateText = monthDateLongFormat.format(nextMondayDate) + " " + nextMondayDate.getFullYear();
    var emailSubject = "Availability for " + dateText + " [Footie, Goodwin, 6pm Mondays]"
    var emailBody = "Hi all,\n\nA new month so a new poll.  You know what to do...\n"
    emailBody += "https://tensile-spirit-360708.nw.r.appspot.com/poll"
    emailBody += "\n\nAlso, outstanding payments for games over the last couple of months when you get a sec please...\n"
    emailBody += "***PAYMENTS WILL GO HERE - DO NOT DELETE THIS LINE***";
    emailBody += "\n\nCheers,\nPhil\n"
    emailBody += "\nMobile: 07960951917\n"
    emailBody += "https://tensile-spirit-360708.nw.r.appspot.com/poll\n"
    //emailBody += "\n-----------\n"
    //emailBody += "To unsubscribe: https://tensile-spirit-360708.nw.r.appspot.com/mailing-list?type=unsubscribe\n"
    document.getElementById("emailTitle").value = emailSubject;
    document.getElementById("emailBody").value = emailBody;
    document.getElementById("emailTitle").style.width = "100%";
    document.getElementById("emailBody").style.width = "100%";
  }

  function generateFirstIntroEmailText() {
    var dateText = monthDateLongFormat.format(nextMondayDate) + " " + nextMondayDate.getFullYear();
    var emailSubject = "Monday Night Football Game [Footie, Goodwin, 6pm Mondays]"
    var emailBody = "Hi,"
    emailBody += "\n\nSomeone mentioned that you might be interested in a game of footie so I've added you to our mailing list."
    emailBody += "\n\nWe play 6-a-side every Monday at 6pm at Goodwin Sports Centre in Broomhill.";
    emailBody += "\n\nInstructions are easy... ";
    emailBody += "\n- Fill out the poll - an email will be sent each month with a poll for the games in that month. ";
    emailBody += "\n- Each week teams are automatically created from the poll and an email sent round.  ";
    emailBody += "\n- If there are more than 12 players then you might be on standby - watch out for your emails in case anyone drop-outs and the standby players come in.";
    emailBody += "\n- Payment is at the end of the month - I'll send an email with a PayPal link";
    emailBody += "\n\nHere is the usual poll link (It's the same link each month so you can bookmark it)...";
    emailBody += "\nhttps://tensile-spirit-360708.nw.r.appspot.com/poll";
    emailBody += "\n\nHopefully see you sometime next month.";
    emailBody += "\n\nCheers,";
    emailBody += "\nPhil";
    document.getElementById("emailTitle").value = emailSubject;
    document.getElementById("emailBody").value = emailBody;
    document.getElementById("emailTitle").style.width = "100%";
    document.getElementById("emailBody").style.width = "100%";
  }
  
  function generatePaymentsEmailText() {
    document.getElementById("paymentsEntryDiv").innerHTML = '<p>';
    addPaymentsTableRows(outstandingPayments, true, false);

    var emailSubject = "Payments for Monday Footie Please [Footie, Goodwin, 6pm Mondays]"
    var emailBody = "Hi all,\n\nOutstanding payments for games over the last few months when you get a sec please...\n\n"
    emailBody += "***PAYMENTS WILL GO HERE - DO NOT DELETE THIS LINE***";
    emailBody += "\n\nCheers,\nPhil\n"
    emailBody += "\nMobile: 07960951917\n"
    emailBody += "https://tensile-spirit-360708.nw.r.appspot.com/poll\n"
    //emailBody += "\n-----------\n"
    //emailBody += "To unsubscribe: https://tensile-spirit-360708.nw.r.appspot.com/mailing-list?type=unsubscribe\n"
    document.getElementById("emailTitle").value = emailSubject;
    document.getElementById("emailBody").value = emailBody;
    document.getElementById("emailTitle").style.width = "100%";
    document.getElementById("emailBody").style.width = "100%";

    //document.getElementById("emailBody").value = document.getElementById("paymentsEntryDiv").innerText;
  }

  function updateEmailButton() {
    // check if sending real or test emails
    if (document.getElementById("sendTestEmailList").checked) {
      document.getElementById("sendEmail").innerText = "Send Email to Test list"
    } else {
      document.getElementById("sendEmail").innerHTML = "Send Email to " + Object.keys(playerAliasMaps.activeEmailList).length + " players";
    }
  }

  function sendEmail() {
    var emailTo = [];
    // check if sending real or test emails
    if (document.getElementById("sendTestEmailList").checked) {
      // test so create a dummy array
      emailTo = testEmailList;
    } else {
      // real email list so get array from the values of activeEmailList
      emailTo = Object.values(playerAliasMaps.activeEmailList);
      if (!confirm('This will send an email to everyone on the mailing list.\nAre you sure?')) return;
    }

    var emailSubject = document.getElementById("emailTitle").value;
    var emailBody = document.getElementById("emailBody").value;
    emailBody = emailBody.replaceAll("\n", '<br>');
    emailBody = emailBody.replace("***PAYMENTS WILL GO HERE - DO NOT DELETE THIS LINE***", document.getElementById("paymentsEntryDiv").innerHTML);
    var emailDetails = { 'emailSubject': emailSubject, 'emailBody': emailBody, 'emailTo': emailTo };
    // now send the POST request with the data
    console.log(emailDetails)

    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        console.log("Saved response", this.responseText);
        //location.reload(true);
        document.getElementById("sendEmail").innerHTML = "EMAIL SENT!";
        document.getElementById("sendEmail").disabled = true;
        document.getElementById("emailTitle").disabled = true;
        document.getElementById("emailBody").disabled = true;
        document.getElementById("randomiseAgain").style.visibility = "hidden";
      }
    };
    xmlhttp.open("POST", "/send-email");
    xmlhttp.setRequestHeader("Content-Type", "application/json");
    xmlhttp.send(JSON.stringify(emailDetails));
  }

  // auto select the
  var algorithmIndex = new URL(document.location.href).searchParams.get("algorithm");
  var selectAlgorithm = (algorithmIndex && algorithmIndex <= document.getElementById("algorithmChoice").length) ? algorithmIndex : 3;
  document.getElementById("algorithmChoice").selectedIndex = selectAlgorithm;
  document.getElementById('algorithmChoice').dispatchEvent(new Event('change'));
  
  // change the algorithm for all players and regenerate teams
  var emailTemplate = new URL(document.location.href).searchParams.get("template");
  if (!emailTemplate) { emailTemplate = "teams" };
  document.getElementById("emailChoice").value = emailTemplate;
  document.getElementById('emailChoice').dispatchEvent(new Event('change'));
  //changeOption(emailTemplate);

  </script>

  </body>
</html>
