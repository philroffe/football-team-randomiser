
  <script type="text/javascript">
  
    function closeMonthGeneratePayments() {
      var attendanceDetails = { "gameYear": gameYear, "gameMonth": gameMonth };
      // now send the POST request with the data
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log("Saved response", this.responseText);
          location.reload(true);
        }
      };
      xmlhttp.open("POST", "/create-payments-for-month");
      xmlhttp.setRequestHeader("Content-Type", "application/json");
      xmlhttp.send(JSON.stringify(attendanceDetails));
    }

    function editPayments() {
      // toggle the button
      var isEditing = false;
      var editPaymentsButton = document.getElementById("editPaymentsButton"); 
      var cancelPaymentsButton = document.getElementById("cancelPaymentsButton"); 
      if (editPaymentsButton.innerHTML == "Edit") {
        editPaymentsButton.innerHTML = "Save"
        cancelPaymentsButton.disabled = false;
        isEditing = false;
      } else {
        editPaymentsButton.innerHTML = "Edit"
        cancelPaymentsButton.disabled = true;
        isEditing = true;
      }

      // show/hide the checkboxes
      var currentPlayerNumber = 0;
      var paydetails = {};

      Object.keys(attendanceMap).sort().forEach(function(playerName) {
        var playerNameElement = document.getElementById("player" + playerName + "NamePayment"); 
        var playerPaymentAmountElement = document.getElementById("player" + currentPlayerNumber + "AmountPayment"); 
        var paymentLinkElement = document.getElementById("player" + currentPlayerNumber + "LinkPayment"); 
        if (playerPaymentAmountElement) {
          playerPaymentAmountElement.hidden = isEditing;

          var paymentNumber = 0;
          (playerPaymentAmountElement.value) ? paymentNumber += playerPaymentAmountElement.value : newURL += 0;
          paydetails[playerNameElement.innerHTML] = paymentNumber;
        }
        currentPlayerNumber++;
      })

      if (editPaymentsButton.innerHTML == "Edit") {
        // now send the POST request with the data
        var savedata = { "gameYear": gameYear, "gameMonth": gameMonth, "paydetails": paydetails };
        console.log("SAVING PAYMENTS:" + JSON.stringify(savedata));
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            console.log("Saved response", this.responseText);
            location.reload(true);
          }
        };
        xmlhttp.open("POST", "/save-payment");
        xmlhttp.setRequestHeader("Content-Type", "application/json");
        xmlhttp.send(JSON.stringify(savedata));
      }
    }

    function addPaymentsToTab() {
      var currentPlayerNumber = 0;

      // sort by paid status, split names into separate arrays and then concat together
      var playersPaid = {};
      var playersUnPaid = {};
      Object.keys(attendanceMap).sort().forEach(function(playerName) {
        // count the amount owed for each game that they actively played
        var amountOwed = 0;
        Object.keys(attendanceMap[playerName]).sort().forEach(function(games) {
          if (attendanceMap[playerName][games]) { amountOwed += 4; }
        })

        var outstandingBalance = amountOwed;
        if (paydetailsMap[playerName]) {
          outstandingBalance = amountOwed - paydetailsMap[playerName];
        }
        //console.log(playerName, amountOwed, paydetailsMap[playerName], outstandingBalance)
        if (outstandingBalance <= 0) { 
          playersPaid[playerName] = amountOwed;
        } else {
          playersUnPaid[playerName] = amountOwed;
        }
      })

      //var playersOrdered = playersUnPaid.concat(playersPaid);
      let playersOrdered = {
          ...outstandingPaymentsMap,
          ...playersUnPaid,
          ...playersPaid
      };


      if (!mondaysDates) {
        mondaysDates = mondaysInMonth(pollDate.getMonth()+1, pollDate.getFullYear());  //=> [ 7,14,21,28 ]
      }

      var outstandingPaymentsThisMonthMap = {};
      // count the number of games that they actively played
      Object.keys(playersOrdered).forEach(function(playerName) {
        var numberOfGames = 0;
        var amountOwed = 0;
        var amountPaid = 0;
        var outstandingBalance = 0;
        var charges = [];
        var payments = [];
        if (attendanceMap[playerName]) {
          Object.keys(attendanceMap[playerName]).sort().forEach(function(games) {
            if (attendanceMap[playerName][games]) { 
              numberOfGames++;
              charges.push(pollDate.getFullYear() + "-" + (pollDate.getMonth()+1) + "-" + mondaysDates[games]);
            }
          })
          if (paydetailsMap[playerName]) { amountPaid = Number(paydetailsMap[playerName]); }
          amountOwed = Number(playersOrdered[playerName]);
          outstandingBalance = (numberOfGames*4) - amountPaid;
          //console.log(playerName, (numberOfGames), amountOwed, amountPaid, outstandingBalance, charges, payments);
        } else {
          numberOfGames = 0;
        }
        // add to the map
        outstandingPaymentsThisMonthMap[playerName] = { "numberOfGames": numberOfGames, "amountOwed": amountOwed, "amountPaid": amountPaid, "outstandingBalance": outstandingBalance, "charges": charges, "payments": payments}
      });

      var panelcontentouter = document.getElementById("paymentsEntryDiv");
      if (Object.keys(outstandingPaymentsMap).length > 0) {
        panelcontentouter.appendChild(document.createTextNode("Outstanding Balances:"));
        addPaymentsTableRows(outstandingPaymentsMap, false, true, document, panelcontentouter);
        panelcontentouter.appendChild(document.createElement("br"));
      }
      panelcontentouter.appendChild(document.createTextNode("This Month:"));
      addPaymentsTableRows(outstandingPaymentsThisMonthMap, true, true, document, panelcontentouter);
}

function togglePaymentVisbility(e) {
  //console.log("Cell clicked...", e.srcElement.id, e.srcElement.innerText);
  var tableCellId = e.srcElement.id;
  tableCellId = tableCellId.replace(/List/, '');
  var paymentsListElement = document.getElementById(tableCellId + "List");

  if (paymentsListElement.hidden) {
    paymentsListElement.hidden = false;
    e.srcElement.className = "contractable";
  } else {
    paymentsListElement.hidden = true;
    e.srcElement.className = "expandable";
  }
}

  </script>