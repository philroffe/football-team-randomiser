<!DOCTYPE html>
<html lang="en">
<head>
  <%- include ("../partials/header.ejs") %>

  <style>
  .borderdiv {
    background-color: #D5EDF6;
    color: #333333;
    padding: 2px 6px 2px 6px;
    border-top: 1px solid #D5EDF6;
    border-right: 1px solid #333333;
    border-bottom: 1px solid #333333;
    border-left: 1px solid #D5EDF6;
  }
  </style>
</head>

<body class="w3-light-grey">
  <%- include ("../partials/nav.ejs") %>
  <!-- Page content -->
  <div class="w3-content" style="max-width:2000px;margin-top:46px;margin-left: 10px;">

    <div id="mailList">
      <h3>View Your Payment History</h3>
      Shows all payments that have been recorded and the games they related to.

      <!-- Radio buttons -->
      <div class="borderdiv" id="generateEmailLinkDiv">
        <p>
          <div id="borderTitle"><H4>Get Link by Email</H4>
          Can't remember how many games you played this month?
          <br>Can't remember if you've paid?
          <br>Think you've been charged incorrectly?
          <p><div id="helperText">Enter your registered email and you'll recieve a direct link to that address.</div>
          </div>
        <input type="email" id="email" placeholder="Email" oninput="validateEmail(this);" data-lpignore=true>
        <br><br><button id="submit" style="background-color: #90EE90;float:left;" type="button" onclick="submitEmail();" disabled>Submit</button><br><br>
        <p><div id="response"></div>
          Note: For your privacy, this page is protected. You’ll need to use the unique link sent to your registered email address to view your payment history securely.
      </div>
      <div id="details">
        <div id="name"></div>
        <h5>Outstanding Charges/Payments (not yet processed)</h5>
        <div id="showCharges"></div>
        <h5>Payments History</h5>
        <div id="showPayments"></div>
      </div>
    

    <script type="text/javascript">
      // restringify and then parse the json to get the page
      var pageData = JSON.parse(JSON.stringify(<%- pageData %>));
      console.log('pageData=', pageData);

      var paymentData = pageData.paymentData;
      var openLedger = paymentData.openLedger;
      var closedLedger = paymentData.closedLedger;
      var unprocessedPayments = paymentData.unprocessedPayments;
      //var token = pageData.token;
      console.log('paymentData=', paymentData);
      if (paymentData.name) {
        document.getElementById("generateEmailLinkDiv").style.display = "none";
        document.getElementById("name").innerHTML = "<h4>" + paymentData.name + " - " + paymentData.email + "</h4><hr style='border-top: 1px dashed #999;'>";
        var options = { weekday: 'short', year: 'numeric', month: 'long', day: '2-digit' };

        //////////////////////////////
        // sort the openLedger keys and print details
        var chargesText = "<pre>";
        var totalCharges = 0;
        const orderedOpenLedger = Object.keys(paymentData.openLedger).sort().reduce(
          (obj, key) => { obj[key] = paymentData.openLedger[key]; return obj; }, {}
        );
        for (var charge in orderedOpenLedger) {
          var dateText = charge.replace("charge_", "");
          var date = new Date(dateText);
          var optionDate = date.toLocaleDateString("en-GB", options);
          var amount = Number(paymentData.openLedger[charge].amount);
          chargesText += "\nCharge: " + optionDate + " | £" + amount*-1;
          totalCharges -= amount;
        }

        // print details of any unprocessed payments
        var totalUnprocessedPayments = 0;
        if (unprocessedPayments.length > 0) {
          for (var i = 0; i < unprocessedPayments.length; i++) {
            var optionDate = new Date(unprocessedPayments[i].transactionDate._seconds*1000).toISOString().split('T')[0];
            chargesText += "\nPayment: " + optionDate + " | " + unprocessedPayments[i].transactionId + " | £" + unprocessedPayments[i].amount;
            totalUnprocessedPayments += Number(unprocessedPayments[i].amount);
          }
        } else {
          chargesText += "\nPayment: No known unprocessed payments."
        }
        //chargesText += "\n" + unprocessedPaymentsText + "";
        chargesText += "\n\nTotal Owed:     £" + totalCharges + "";
        chargesText += "\nTotal Recieved: £" + totalUnprocessedPayments + "</pre><hr style='border-top: 1px dashed #999;'>";
        document.getElementById("showCharges").innerHTML = chargesText;

        //////////////////////////////
        // sort the openLedger keys and print details
        var paymentsText = "<pre>";
        const orderedClosedLedger = Object.keys(closedLedger).sort().reverse().reduce(
          (obj, key) => { obj[key] = closedLedger[key]; return obj; }, {}
        );

        var playerAccounts = "<pre>";
        var totalPayments = 0;
        var totalCost = 0;
        // loop through all the payments for the players
        for (var paymentsKey in orderedClosedLedger) {
          if (paymentsKey.startsWith("payment_")) {
            var paymentDate = paymentsKey.split("_")[1];
            var date = new Date(paymentDate);
            var optionDate = date.toLocaleDateString("en-GB", options);
            var transactionId = closedLedger[paymentsKey].paypalTransactionId;
            var paymentAmount = Number(closedLedger[paymentsKey].amount);
            totalPayments += Number(paymentAmount);
            playerAccounts += "Payment: " + optionDate + " | £" + paymentAmount + " | " + transactionId + "\n";
            closedLedger[paymentsKey].accountedFor = true;

            // loop through all the games for the player and match the payment
            for (var paymentsKey in orderedClosedLedger) {
              if (paymentsKey.startsWith("charge_") && closedLedger[paymentsKey].paid == transactionId) {
                var chargeAmount = closedLedger[paymentsKey].amount;
                var chargeWeek = paymentsKey.replace(/charge_/, '');
                var date = new Date(chargeWeek);
                var optionDate = date.toLocaleDateString("en-GB", options);
                var paymentFor = (closedLedger[paymentsKey].paymentFor) ? " (" + closedLedger[paymentsKey].paymentFor + ")" : "";
                var additionalInfo = (closedLedger[paymentsKey].additionalInfo) ? " (" + closedLedger[paymentsKey].additionalInfo + ")" : "";
                playerAccounts += "    " + optionDate + " | £" + (chargeAmount*-1) + paymentFor + additionalInfo + "\n";
                totalCost += chargeAmount;
                closedLedger[paymentsKey].accountedFor = true;
              }
            };
          }
        };
        playerAccounts += "  </pre>";
        document.getElementById("showPayments").innerHTML = playerAccounts;
      } else {
        document.getElementById("details").style.display = "none";
      }


      function validateEmail(input) {
        document.getElementById("response").innerHTML = "";
        var validRegex = /^([a-zA-Z0-9._%\-\+]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})$/;
        if (input.value.trim().match(validRegex)) {
          //console.log("Valid email address!");
          //input.style.border="2px solid green";
          document.getElementById("submit").disabled = false;
          return true;
        } else {
          //console.log("Invalid email address!");
          //document.email.focus();
          //input.style.border="5px solid red";
          document.getElementById("submit").disabled = true;
          return false;
        }
      }

      function validateName(input) {
        document.getElementById("response").innerHTML = "";
        var isValidEmail = validateEmail(document.getElementById("email"));
        if (isValidEmail && input.value.trim().length > 2) {
          document.getElementById("submit").disabled = false;
          return false;
        } else {
          document.getElementById("submit").disabled = true;
          return true;
        }
      }

      function validateAll(isValidEmail, isValidName) {
        if (isValidEmail && isValidName) {
          document.getElementById("submit").disabled = false;
        } else {
          document.getElementById("submit").disabled = true;
        }
      }

      function changeHelpText() {
        var subscribeType = document.getElementsByName("subscribeType")[0];
        document.getElementById("response").innerHTML = "";
        if (subscribeType.checked) {
          document.getElementById("borderTitle").innerHTML = "<h3>Subscribe</h3>";
          document.getElementById("helperText").innerHTML = "An email will be sent with a confirmation link.  <br>Make sure you confirm your email to join the list.";
          document.getElementById("fullnameDiv").style.visibility = "visible";
        } else {
          document.getElementById("borderTitle").innerHTML = "<h3>Unsubscribe</h3>";
          document.getElementById("helperText").innerHTML = "You will be unsubscribed from any future team and availability emails from the organiser.";
          document.getElementById("fullnameDiv").style.visibility = "hidden";
        }
      }

      function submitEmail() {
        var details = {};
        details.email = document.getElementById("email").value.trim();

        document.getElementById("response").innerHTML = "Submitting...";

        // now send the POST request with the data
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            console.log("Saved response", this.responseText);
            //location.reload(true);
            document.getElementById("response").innerHTML = "Success - if this email is on the mailing list then you will recieve an email with a link to view your payment history.<br>(Note: The link is unique to you and never changes so you can bookmark it once you have it, or simply request it again in the form below.)";
            document.getElementById("submit").disabled = true;
          } else if (this.readyState == 4) {
            document.getElementById("response").innerHTML = "Error!  Something went wrong - contact the organiser.";
          }
        };
        xmlhttp.open("POST", "/services/generate-payment-history-link");
        xmlhttp.setRequestHeader("Content-Type", "application/json");
        xmlhttp.send(JSON.stringify(details));
      }
    </script>
  </div>
</body>
</html>
